<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Plataforma IoT</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Mantengo todo tu CSS original */
    /* ... (omitido aquí por brevedad) ... */
  </style>
</head>
<body>
  <!-- Mantengo todo tu HTML de estructura: header, secciones, formularios, etc. -->
  <!-- ... (omitido por brevedad) ... -->

  <script>
    // Variables globales con persistencia
    let usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
    let dispositivos = JSON.parse(localStorage.getItem('dispositivos')) || {};
    let usuarioActual = null;

    function guardarDatos() {
      localStorage.setItem('usuarios', JSON.stringify(usuarios));
      localStorage.setItem('dispositivos', JSON.stringify(dispositivos));
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('tipoDispositivo').addEventListener('change', function() {
        const contenedor = document.getElementById('contenidoCamposDinamicos');
        const seccionCampos = document.getElementById('camposDinamicos');
        contenedor.innerHTML = '';
        seccionCampos.style.display = 'none';

        if (this.value === 'Sensor de Temperatura') {
          contenedor.innerHTML = `
            <div class="grupo-formulario">
              <label>Unidad de medida</label>
              <select class="campo-adicional" id="unidadTemperatura">
                <option>Celsius (°C)</option>
                <option>Fahrenheit (°F)</option>
                <option>Kelvin (K)</option>
              </select>
            </div>
            <div class="grupo-formulario">
              <label>Rango de medición</label>
              <input type="text" class="campo-adicional" id="rangoTemperatura" placeholder="Ej: -40 a 125°C">
            </div>`;
          seccionCampos.style.display = 'block';
        } else if (this.value === 'Cámara IP') {
          contenedor.innerHTML = `
            <div class="grupo-formulario">
              <label>Resolución</label>
              <input type="text" class="campo-adicional" id="resolucionCamara" placeholder="Ej: 1920x1080">
            </div>
            <div class="grupo-formulario">
              <label>Protocolo</label>
              <select class="campo-adicional" id="protocoloCamara">
                <option>RTSP</option>
                <option>ONVIF</option>
                <option>HTTP</option>
              </select>
            </div>`;
          seccionCampos.style.display = 'block';
        }
      });
    });

    function agregarDispositivo() {
      const usuario = usuarioActual.usuario;
      const nombre = document.getElementById('nombreDispositivo').value;
      const tipo = document.getElementById('tipoDispositivo').value;
      if (!nombre || !tipo) return alert('Complete los campos.');

      const nuevoDispositivo = { nombre, tipo, estado: 'online', ultimaActualizacion: new Date().toLocaleString() };
      const campos = document.querySelectorAll('.campo-adicional');
      campos.forEach(c => nuevoDispositivo[c.id] = c.value);

      if (!dispositivos[usuario]) dispositivos[usuario] = [];
      dispositivos[usuario].push(nuevoDispositivo);
      guardarDatos();
      agregarDispositivoAInterfaz(nuevoDispositivo);

      document.getElementById('nombreDispositivo').value = '';
      document.getElementById('tipoDispositivo').selectedIndex = 0;
      document.getElementById('camposDinamicos').style.display = 'none';
    }

    function agregarDispositivoAInterfaz(d) {
      const lista = document.getElementById('device-list');
      if (lista.innerHTML.includes('No tienes')) lista.innerHTML = '';
      const item = document.createElement('div');
      item.className = 'item-dispositivo';

      let props = '';
      for (let k in d) {
        if (!['nombre','tipo','estado','ultimaActualizacion'].includes(k)) {
          props += `<div><small>${k}: ${d[k]}</small></div>`;
        }
      }

      item.innerHTML = `
        <div class="info-dispositivo">
          <div class="nombre-dispositivo">${d.nombre}</div>
          <div class="tipo-dispositivo">${d.tipo}</div>
          ${props}
          <div style="margin-top: 10px;">
            <span class="estado-dispositivo">${d.estado}</span>
            <span style="color: #718096; font-size: 0.8rem; margin-left: 10px;">
              <i class="far fa-clock"></i> ${d.ultimaActualizacion}
            </span>
          </div>
        </div>
        <div class="acciones-dispositivo">
          <button class="btn-accion btn-eliminar" onclick="eliminarDispositivo('${d.nombre}')">
            <i class="fas fa-trash"></i>
          </button>
        </div>`;
      lista.appendChild(item);
    }

    function eliminarDispositivo(nombre) {
      const usuario = usuarioActual.usuario;
      dispositivos[usuario] = dispositivos[usuario].filter(d => d.nombre !== nombre);
      guardarDatos();
      cargarDispositivos(usuario);
    }

    function cargarDispositivos(usuario) {
      const lista = document.getElementById('device-list');
      lista.innerHTML = '';
      const datos = dispositivos[usuario] || [];
      if (datos.length === 0) {
        lista.innerHTML = '<p>No tienes dispositivos registrados.</p>';
      } else {
        datos.forEach(d => agregarDispositivoAInterfaz(d));
      }
    }

    // Resto de funciones showAuthSection, mostrarBienvenida, mostrarPanel, etc. sin cambios.
    // Registro, login, edición de perfil: asegúrate de actualizar usuario en array usuarios:

    document.getElementById('formularioPerfil').addEventListener('submit', e => {
      e.preventDefault();
      const actual = document.getElementById('contrasenaActual').value;
      const nueva = document.getElementById('nuevaContrasena').value;
      if (actual !== usuarioActual.contrasena) return alert('Contraseña incorrecta.');
      if (nueva && nueva.length < 8) return alert('La nueva contraseña es muy corta.');

      usuarioActual.nombre = document.getElementById('perfilNombre').value;
      usuarioActual.correo = document.getElementById('perfilEmail').value;
      if (nueva) usuarioActual.contrasena = nueva;

      const index = usuarios.findIndex(u => u.usuario === usuarioActual.usuario);
      if (index !== -1) usuarios[index] = { ...usuarioActual };
      guardarDatos();

      alert('Perfil actualizado correctamente.');
    });
  </script>
</body>
</html>
